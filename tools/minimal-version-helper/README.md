# Minimal Version Helper

This is an internal developer tool designed to prepare the workspace for testing
against the minimal supported versions of our dependencies.

## What it Does

The tool has two main commands: `prepare` and `revert`.

### `prepare`

This command modifies the root `Cargo.toml` to simulate a release environment
where dependencies are fetched from a registry like `crates.io` rather than from
the local filesystem.

Specifically, it:

1. Removes all `path = "..."` entries from the `[workspace.dependencies]` table
   in the root `Cargo.toml`.
1. Queries `crates.io` to identify which local crates specified as dependencies
   are not yet published.
1. Generates a `.cargo/config.toml` file with a `[patch.crates-io]` section.
   This section tells Cargo to use the local source code for any unpublished
   crate versions, while allowing published crates to be resolved from the
   registry.
1. Performs a version consistency check to ensure that the versions specified in
   the root `Cargo.toml` for patched crates match the versions in the crates'
   own `Cargo.toml` files.

#### The `--local` flag

When running `prepare` locally, you should always use the `--local` flag:

```bash
cargo run -p minimal-version-helper -- prepare --local
```

This flag tells the tool to back up your original `Cargo.toml` and
`.cargo/config.toml` (if it exists) before making any changes. This is crucial
for being able to restore your workspace after you're done testing.

### `revert`

This command restores the workspace to its original state by reverting the
changes made by `prepare --local`. It will:

1. Restore `Cargo.toml` from `Cargo.toml.bak`.
1. Restore `.cargo/config.toml` from `.cargo/config.toml.bak` if it exists.
1. If no backup exists for `.cargo/config.toml`, it will remove the file that
   was generated by the `prepare` step.

## Local Usage Workflow

To test your changes against minimal dependency versions locally, follow these
steps:

1. **Prepare the environment:**

   ```bash
   cargo run -p minimal-version-helper -- prepare --local
   ```

1. **Run the minimal versions check:**

   ```bash
   cargo minimal-versions test -p your-crate-name
   ```

   *(Replace `your-crate-name` with the crate you are testing.)*

1. **Revert the changes:** Once you are finished with your testing, run the
   revert command to restore your workspace to its normal development state.

   ```bash
   cargo run -p minimal-version-helper -- revert
   ```
